<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Registros ATREVETE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
        // Configuración de Tailwind (copiada de tu código original)
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        slate: { 850: '#1e293b', 950: '#020617' }
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    },
                    animation: {
                        fadeIn: 'fadeIn 0.3s ease-out',
                        slideUp: 'slideUp 0.4s ease-out'
                    }
                },
            },
        };
    </script>

    <style>
        body {
            background-color: #F8F7FF;
            color: #1e293b;
        }
        /* Oculta los botones de subir/bajar en input[type=number] */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>

<body>
    <div id="root">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; font-family: sans-serif;">
            <svg class="animate-spin" style="width: 40px; height: 40px; margin-bottom: 16px; color: #6366f1;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p>Iniciando la aplicación...</p>
        </div>
    </div>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // =================================================================
        // 1. CONFIGURACIÓN E INTEGRACIÓN CON GOOGLE APPS SCRIPT
        // =================================================================
        
        // TU URL DE GOOGLE APPS SCRIPT
        const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwxuRanzdOQ2NVkbfMHz0q2En00gG-_oYnHWeak3omCgFuuSntJXN6191zNjKkShdLBWQ/exec';

        // Función para OBTENER la configuración (Estudiantes, Terapeutas, Programas)
        const fetchSheetConfig = async () => {
            const url = `${APP_SCRIPT_URL}?requestType=GET_CONFIG`;
            const response = await fetch(url);
            
            if (!response.ok) {
                console.error("Error al conectar con Apps Script.");
                throw new Error('Error de red o el servicio de Apps Script no está disponible.');
            }
            
            return response.json();
        };

        // Función para GUARDAR la sesión
        const saveSessionToSheet = async (data) => {
            const response = await fetch(APP_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    requestType: 'SAVE_SESSION', 
                    payload: data 
                })
            });
            
            if (!response.ok) {
                throw new Error('Error al enviar datos. Revisa la función doPost en tu Apps Script.');
            }
            
            return response.json(); 
        };

        // Servicio Simulador para la Generación de Resumen (Requiere una API Key real para funcionar completamente)
        const generateSessionSummary = async (data) => {
            await new Promise(resolve => setTimeout(resolve, 1500)); // Simula tiempo de carga
            return `[Resumen Simulado]: Sesión con ${data.studentName}. Se registraron ${data.programs.length} programas. ${data.generalObservations}`;
        };

        // =================================================================
        // 2. CONSTANTES GLOBALES (Necesarias por ProgramCard.tsx)
        // =================================================================
        const HELP_OPTIONS = [
            { value: 'fisica', label: 'Física' },
            { value: 'gestual', label: 'Gestual' },
            { value: 'verbal', label: 'Verbal' },
            { value: 'visual', label: 'Visual' },
            { value: 'posicional', label: 'Posicional' },
        ];
        const REINFORCER_OPTIONS = [
            { value: 'comida', label: 'Comida' },
            { value: 'social', label: 'Social' },
            { value: 'actividad', label: 'Actividad' },
            { value: 'tangible', label: 'Tangible' },
        ];
        // Ajustado para coincidir con la lógica que usa 'IF' y 'IV'
        const REINFORCEMENT_SCHEDULES = ['FR', 'VR', 'FI', 'VI', 'Razón Continua (RC)']; 
        
        // =================================================================
        // 3. COMPONENTE ProgramCard (Código de ProgramCard.tsx)
        // =================================================================
        const ProgramCard = ({ program, onUpdate, onRemove }) => {
            
            const handleMultiSelect = (field, value) => {
                const current = program[field];
                const updated = current.includes(value)
                ? current.filter(item => item !== value)
                : [...current, value];
                onUpdate(program.id, { [field]: updated });
            };

            // Asegurar que las variables coincidan con las que usa tu App.tsx para Intervalos
            const isIntervalSchedule = ['FI', 'VI'].includes(program.reinforcementSchedule);

            const CounterInput = ({ label, value, onChange, colorClass }) => (
                <div className="flex flex-col gap-2 w-full">
                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider text-center">{label}</label>
                    <div className="relative">
                    <input
                        type="number"
                        min="0"
                        value={value === 0 ? '' : value}
                        placeholder="0"
                        onChange={(e) => {
                        const valStr = e.target.value;
                        const val = valStr === '' ? 0 : parseInt(valStr, 10);
                        if (!isNaN(val)) {
                            onChange(val);
                        }
                        }}
                        onFocus={(e) => e.target.select()}
                        className={`
                        w-full h-14 text-2xl font-bold text-center rounded-xl border-2 transition-all outline-none focus:ring-4
                        ${colorClass}
                        border-slate-100 bg-slate-50 focus:bg-white focus:border-transparent focus:ring-indigo-500/10
                        placeholder-slate-300
                        `}
                    />
                    </div>
                </div>
            );

            return (
                <div className={`bg-white rounded-2xl shadow-sm border border-slate-200 transition-all duration-300 ${program.isCollapsed ? 'opacity-80' : 'opacity-100 ring-4 ring-slate-50 border-slate-300'}`}>
                    
                    {/* Header */}
                    <div 
                        className="p-4 flex items-center justify-between cursor-pointer hover:bg-slate-50 border-b border-slate-100 rounded-t-2xl transition-colors"
                        onClick={() => onUpdate(program.id, { isCollapsed: !program.isCollapsed })}
                    >
                        <div className="flex items-center gap-3">
                        <div className="bg-indigo-50 w-8 h-8 rounded-lg flex items-center justify-center text-indigo-600 border border-indigo-100">
                            <div className="w-2.5 h-2.5 bg-current rounded-sm transform rotate-45"></div>
                        </div>
                        <div>
                            <h3 className="font-semibold text-base text-slate-800">{program.name}</h3>
                            {program.isCollapsed && (
                            <p className="text-xs text-slate-500">
                                {program.correctCount} Aciertos | {program.incorrectCount} Errores
                            </p>
                            )}
                        </div>
                        </div>
                        <div className="flex items-center gap-1">
                        <button 
                            onClick={(e) => { e.stopPropagation(); onRemove(program.id); }}
                            className="p-2 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-colors"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                        <button className="p-2 text-slate-400 hover:text-slate-600 rounded-lg">
                            {program.isCollapsed ? (
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"></path></svg>
                            ) : (
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"></path></svg>
                            )}
                        </button>
                        </div>
                    </div>

                    {!program.isCollapsed && (
                        <div className="p-5 space-y-8 animate-fadeIn">
                        
                        {/* Section: Metrics (Inputs & Counters) */}
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            
                            {/* Left: Text Inputs */}
                            <div className="lg:col-span-5 space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-1.5">
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Conj/Nivel</label>
                                <input 
                                    type="text" 
                                    value={program.level}
                                    onChange={(e) => onUpdate(program.id, { level: e.target.value })}
                                    className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500 focus:outline-none transition-all placeholder-slate-400 text-slate-800"
                                    placeholder="Ej. A1"
                                />
                                </div>
                                <div className="space-y-1.5">
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Elementos</label>
                                <input 
                                    type="text" 
                                    value={program.elements}
                                    onChange={(e) => onUpdate(program.id, { elements: e.target.value })}
                                    className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500 focus:outline-none transition-all placeholder-slate-400 text-slate-800"
                                    placeholder="Ej. Manzana"
                                />
                                </div>
                            </div>

                            <div className="flex gap-4">
                                <div className="space-y-1.5 w-full">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Programa de Ref.</label>
                                    <div className="relative">
                                        <select 
                                            value={program.reinforcementSchedule}
                                            onChange={(e) => onUpdate(program.id, { reinforcementSchedule: e.target.value })}
                                            className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm appearance-none focus:outline-none focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500 text-slate-800 cursor-pointer"
                                        >
                                            <option value="" disabled className="text-slate-400">Seleccionar...</option>
                                            {REINFORCEMENT_SCHEDULES.map(opt => (
                                                <option key={opt} value={opt}>{opt}</option>
                                            ))}
                                        </select>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 pointer-events-none"><path d="m6 9 6 6 6-6"></path></svg>
                                    </div>
                                </div>

                                {isIntervalSchedule && (
                                    <div className="space-y-1.5 w-full animate-fadeIn">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1">
                                        Tiempo <span className="text-slate-300">(seg)</span>
                                        </label>
                                        <div className="relative">
                                        <input 
                                            type="text" 
                                            inputMode="numeric"
                                            value={program.reinforcementScheduleTime}
                                            onChange={(e) => onUpdate(program.id, { reinforcementScheduleTime: e.target.value })}
                                            className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500 focus:outline-none transition-all placeholder-slate-400 text-slate-800"
                                            placeholder="30"
                                        />
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 pointer-events-none"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                        </div>
                                    </div>
                                )}
                            </div>
                            </div>

                            {/* Right: Counters */}
                            <div className="lg:col-span-7 bg-white rounded-xl p-4 border border-slate-100 flex items-center gap-6 shadow-[0_2px_10px_rgba(0,0,0,0.02)]">
                            <CounterInput 
                                label="Aciertos" 
                                value={program.correctCount} 
                                onChange={(val) => onUpdate(program.id, { correctCount: val })}
                                colorClass="text-emerald-600"
                            />
                            <div className="h-12 w-px bg-slate-100 flex-shrink-0"></div>
                            <CounterInput 
                                label="Errores" 
                                value={program.incorrectCount} 
                                onChange={(val) => onUpdate(program.id, { incorrectCount: val })}
                                colorClass="text-rose-500"
                            />
                            </div>

                        </div>

                        <div className="h-px bg-slate-100 w-full"></div>

                        {/* Section: Selectors (Pills) */}
                        <div className="grid md:grid-cols-2 gap-8">
                            
                            {/* Help Type */}
                            <div className="space-y-3">
                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                Ayudas <span className="text-slate-400 font-normal normal-case">(Múltiple)</span>
                            </label>
                            <div className="flex flex-wrap gap-2">
                                {HELP_OPTIONS.map((option) => {
                                const isSelected = program.selectedHelp.includes(option.value);
                                return (
                                    <button 
                                    key={option.value} 
                                    onClick={() => handleMultiSelect('selectedHelp', option.value)}
                                    className={`
                                        px-3 py-1.5 rounded-full text-xs font-semibold transition-all duration-200 border
                                        ${isSelected 
                                        ? 'bg-indigo-600 border-indigo-600 text-white shadow-md shadow-indigo-600/20' 
                                        : 'bg-white border-slate-200 text-slate-600 hover:border-indigo-300 hover:text-indigo-600 hover:bg-indigo-50'
                                        }
                                    `}
                                    >
                                    {option.label}
                                    </button>
                                );
                                })}
                            </div>
                            </div>

                            {/* Reinforcer Type */}
                            <div className="space-y-3">
                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                Reforzadores <span className="text-slate-400 font-normal normal-case">(Múltiple)</span>
                            </label>
                            <div className="flex flex-wrap gap-2">
                                {REINFORCER_OPTIONS.map((option) => {
                                const isSelected = program.selectedReinforcer.includes(option.value);
                                return (
                                    <button 
                                    key={option.value} 
                                    onClick={() => handleMultiSelect('selectedReinforcer', option.value)}
                                    className={`
                                        px-3 py-1.5 rounded-full text-xs font-semibold transition-all duration-200 border
                                        ${isSelected 
                                        ? 'bg-teal-600 border-teal-600 text-white shadow-md shadow-teal-600/20' 
                                        : 'bg-white border-slate-200 text-slate-600 hover:border-teal-300 hover:text-teal-600 hover:bg-teal-50'
                                        }
                                    `}
                                    >
                                    {option.label}
                                    </button>
                                );
                                })}
                            </div>
                            </div>

                        </div>

                        </div>
                    )}
                </div>
            );
        };
        
        // =================================================================
        // 4. COMPONENTE Sidebar (Código de Sidebar.tsx)
        // =================================================================
        
        // Iconos (sustituyendo lucide-react)
        const IconUser = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const IconCalendar = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" r="2" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;
        const IconFileText = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path></svg>;
        const IconClock = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const IconChevronDown = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"></path></svg>;
        const IconChevronUp = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"></path></svg>;
        const IconLoader2 = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>;
        const IconWifiOff = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M17.31 17.31A8.995 8.995 0 0 0 12 4c-.75 0-1.48.09-2.19.26"></path><path d="M12 15h.01"></path><path d="M2 8.82a15 15 0 0 1 6.38-4.32"></path><path d="M10.15 19.85a15 15 0 0 0 7.81-2.94"></path><path d="M12 17a3 3 0 0 0 3-3"></path><path d="M7.74 12.01a15 15 0 0 1 8.35 1.58"></path></svg>;
        const IconMenu = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" y1="12" x2="20" y2="12"></line><line x1="4" y1="6" x2="20" y2="6"></line><line x1="4" y1="18" x2="20" y2="18"></line></svg>;
        const IconSparkles = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.998 5.75c0-.6.383-1.127 1.056-1.349l1.92-0.64a.75.75 0 0 1 .528 0l1.92.64c.673.222 1.056.749 1.056 1.35v1.5a.75.75 0 0 1-1.5 0v-1.147L13 5.483V18.25c0 .414-.336.75-.75.75s-.75-.336-.75-.75V5.483L11.5 6.103v1.147a.75.75 0 0 1-1.5 0v-1.5ZM4.998 12.25c0-.414.336-.75.75-.75h14.5a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-.75.75h-14.5a.75.75 0 0 1-.75-.75v-1.5Z" fill="currentColor"></path></svg>;

        // Componente InputField
        const InputField = ({ icon: Icon, label, value, onChange, type = "text", placeholder, extra, options = [], isLoading = false }) => {
            const showSelect = options.length > 0 || isLoading;

            return (
                <div className="group">
                    <label className="text-xs font-bold text-slate-400 mb-1.5 flex items-center gap-2 uppercase tracking-wide group-focus-within:text-indigo-500 transition-colors">
                        <Icon size={12} /> {label} {extra}
                    </label>
                    
                    <div className="relative">
                        {showSelect ? (
                        <div className="relative">
                            <select
                                value={value}
                                onChange={onChange}
                                disabled={isLoading}
                                className={`w-full bg-slate-50 border border-slate-200 focus:border-indigo-500/50 rounded-lg px-3 py-2.5 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500/10 transition-all shadow-sm appearance-none cursor-pointer ${isLoading ? 'text-slate-500 cursor-wait' : 'hover:bg-slate-100'}`}
                            >
                                <option value="" disabled>{isLoading ? "Cargando opciones..." : placeholder}</option>
                                {options.map((opt) => (
                                    <option key={opt} value={opt}>{opt}</option>
                                ))}
                            </select>
                            {isLoading ? (
                                <IconLoader2 className="absolute right-3 top-1/2 transform -translate-y-1/2 text-indigo-500 animate-spin" size={14} />
                            ) : (
                                <IconChevronDown className="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 pointer-events-none" size={14} />
                            )}
                        </div>
                        ) : (
                        <input
                            type={type}
                            value={value}
                            onChange={(e) => onChange(e)}
                            placeholder={placeholder}
                            className="w-full bg-slate-50 hover:bg-slate-100 border border-slate-200 focus:border-indigo-500/50 rounded-lg px-3 py-2.5 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500/10 transition-all shadow-sm"
                        />
                        )}
                    </div>
                </div>
            );
        };
        
        const Sidebar = ({ data, onUpdate, studentOptions, therapistOptions, isLoading = false, isOfflineMode = false }) => {
            const [isMobileOpen, setIsMobileOpen] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);

            const handleGenerateSummary = async () => {
                setIsGenerating(true);
                try {
                    const summary = await generateSessionSummary(data);
                    onUpdate('generalObservations', summary);
                } catch (error) {
                    console.error("Error generating summary:", error);
                    alert("Error al generar resumen. Revisa la configuración del servicio Gemini.");
                } finally {
                    setIsGenerating(false);
                }
            };

            return (
                <aside className={`
                w-full lg:w-80 flex-shrink-0 bg-white lg:h-screen lg:sticky lg:top-0 flex flex-col shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-20 border-r border-slate-100
                transition-all duration-300 ease-in-out
                ${isMobileOpen ? 'h-auto max-h-screen' : 'h-auto'}
                `}>
                {/* Header Section */}
                <div 
                    className="p-6 pb-4 cursor-pointer lg:cursor-default" 
                    onClick={() => setIsMobileOpen(!isMobileOpen)}
                >
                    <div className="flex items-center justify-between">
                    <h1 className="text-lg font-bold text-slate-800 tracking-tight flex items-center gap-2">
                        <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-sm shadow-lg shadow-indigo-600/20">
                        AT
                        </div>
                        <span className="text-slate-700">Registros</span>
                    </h1>

                    <div className="flex items-center gap-2">
                        {isOfflineMode && (
                        <div title="Sin conexión con Sheets. Usando datos de respaldo." className="flex items-center gap-1.5 px-2 py-1 bg-amber-50 text-amber-600 rounded-md border border-amber-100 text-[10px] font-bold uppercase tracking-wide cursor-help">
                            <IconWifiOff size={12} />
                            <span className="hidden sm:inline">Offline</span>
                        </div>
                        )}
                        {/* Mobile Toggle Button */}
                        <button className="lg:hidden p-1 text-slate-400 hover:text-indigo-600 transition-colors">
                            {isMobileOpen ? <IconChevronUp size={20} /> : <IconMenu size={20} />}
                        </button>
                    </div>
                    </div>

                    {/* Mobile Summary (Visible when collapsed) */}
                    {!isMobileOpen && (
                    <div className="lg:hidden mt-3 flex items-center gap-3 text-xs text-slate-500 overflow-hidden">
                        <div className="flex items-center gap-1 truncate">
                            <IconUser size={12} /> 
                            <span className="truncate">{data.studentName || 'Sin alumno'}</span>
                        </div>
                        <div className="w-px h-3 bg-slate-300"></div>
                        <div className="flex items-center gap-1 truncate">
                            <IconUser size={12} /> 
                            <span className="truncate">{data.therapistName || 'Sin terapeuta'}</span>
                        </div>
                    </div>
                    )}
                </div>

                {/* Collapsible Content Area */}
                <div className={`
                    flex-1 flex flex-col overflow-hidden transition-all duration-300
                    ${isMobileOpen ? 'max-h-[80vh] opacity-100' : 'max-h-0 opacity-0 lg:max-h-full lg:opacity-100'}
                `}>
                    <div className="flex-1 overflow-y-auto px-6 space-y-8 pb-4">
                    
                    {/* Context Group */}
                    <div className="space-y-5">
                        <div className="flex items-center gap-2 pb-2 border-b border-slate-100">
                        <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">Contexto</span>
                        </div>
                        
                        <InputField 
                        icon={IconUser} 
                        label="Estudiante" 
                        value={data.studentName} 
                        onChange={(e) => onUpdate('studentName', e.target.value)}
                        placeholder="Seleccionar alumno..."
                        options={studentOptions}
                        isLoading={isLoading}
                        />

                        <InputField 
                        icon={IconUser} 
                        label="Terapeuta" 
                        value={data.therapistName} 
                        onChange={(e) => onUpdate('therapistName', e.target.value)}
                        placeholder="Seleccionar terapeuta..."
                        options={therapistOptions}
                        isLoading={isLoading}
                        />

                        <InputField 
                        icon={IconCalendar} 
                        label="Fecha" 
                        type="date"
                        value={data.date} 
                        onChange={(e) => onUpdate('date', e.target.value)}
                        extra={
                            <span className="ml-auto flex items-center gap-1 text-[10px] text-slate-500 bg-slate-100 border border-slate-200 px-1.5 py-0.5 rounded-md font-medium">
                            <IconClock size={10} /> {data.startTime}
                            </span>
                        }
                        />
                    </div>
                    </div>

                    {/* Observations Sticky Footer */}
                    <div className="p-5 bg-white border-t border-slate-100 space-y-3 shadow-[0_-4px_20px_rgba(0,0,0,0.02)]">
                    <div className="flex justify-between items-center mb-1">
                        <label className="text-xs font-bold text-slate-400 flex items-center gap-2 uppercase tracking-wide">
                        <IconFileText size={12} /> Notas / Resumen
                        </label>
                        <button 
                        onClick={handleGenerateSummary}
                        disabled={isGenerating}
                        className="flex items-center gap-1.5 px-2.5 py-1.5 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-md text-[10px] font-bold uppercase tracking-wider transition-colors disabled:opacity-50 disabled:cursor-wait"
                        title="Generar resumen automático con IA"
                        >
                        {isGenerating ? (
                            <IconLoader2 size={12} className="animate-spin" />
                        ) : (
                            <IconSparkles size={12} />
                        )}
                        {isGenerating ? 'Generando...' : 'Auto-Resumen'}
                        </button>
                    </div>
                    
                    <textarea
                        value={data.generalObservations}
                        onChange={(e) => onUpdate('generalObservations', e.target.value)}
                        placeholder="Escribe notas rápidas aquí..."
                        className="w-full h-32 bg-slate-50 hover:bg-slate-100 border border-slate-200 focus:border-indigo-500/50 rounded-lg px-3 py-3 text-sm text-slate-800 resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500/10 transition-all placeholder-slate-400 shadow-inner"
                    />
                    </div>
                </div>
                </aside>
            );
        };

        // =================================================================
        // 5. COMPONENTE ProgramList (Código de ProgramList.tsx)
        // =================================================================
        
        // Iconos
        const IconPlus = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const IconSearch = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>;
        const IconSave = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>;
        const IconX_20 = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const IconLoader2_24 = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>;

        const ProgramList = ({ 
            programs, 
            availablePrograms,
            onUpdateProgram, 
            onAddProgram, 
            onRemoveProgram,
            onSaveSession,
            isSaving,
            isLoading = false
        }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');

            const handleAdd = (name) => {
                if (!name.trim()) return;
                onAddProgram(name);
                setSearchTerm('');
                setIsModalOpen(false);
            };

            // Filter available programs based on search
            const filteredOptions = useMemo(() => {
                if (!searchTerm) return availablePrograms;
                return availablePrograms.filter(p => 
                p.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [availablePrograms, searchTerm]);

            // Check if the exact term exists to toggle "Create New" button
            const exactMatchExists = filteredOptions.some(
                p => p.toLowerCase() === searchTerm.toLowerCase()
            );

            return (
                <main className="flex-1 p-4 lg:p-10 overflow-y-auto h-screen relative scroll-smooth bg-[#F8F7FF]">
                <div className="max-w-4xl mx-auto space-y-8 pb-32">
                    
                    {/* Header / Action Bar */}
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div className="w-full sm:w-auto flex justify-between items-center">
                        <div>
                        <h2 className="text-2xl font-bold text-slate-900 tracking-tight">Sesión Activa</h2>
                        <p className="text-slate-500 text-sm mt-1 font-medium">
                            {programs.length} {programs.length === 1 ? 'programa' : 'programas'} en curso
                        </p>
                        </div>
                    </div>
                    
                    {/* Desktop Actions */}
                    <div className="hidden sm:flex items-center gap-3">
                        <button 
                            onClick={() => setIsModalOpen(true)}
                            className="bg-white hover:bg-slate-50 text-indigo-600 border border-slate-200 px-5 py-2.5 rounded-full shadow-sm hover:shadow-md transition-all font-semibold flex items-center gap-2 text-sm"
                        >
                            <IconPlus size={18} className="text-indigo-500" />
                            Agregar Programa
                        </button>
                    </div>
                    </div>

                    {/* Cards Stack */}
                    <div className="space-y-6">
                    {programs.map(program => (
                        <ProgramCard 
                        key={program.id} 
                        program={program} 
                        onUpdate={onUpdateProgram}
                        onRemove={onRemoveProgram}
                        />
                    ))}
                    </div>

                    {/* Finish Session Section (Bottom of list) */}
                    {programs.length > 0 && (
                    <div className="flex justify-end pt-8 pb-20 lg:pb-0">
                        <button 
                            onClick={onSaveSession}
                            disabled={isSaving}
                            className="w-full sm:w-auto bg-emerald-600 hover:bg-emerald-500 disabled:opacity-70 disabled:cursor-not-allowed text-white font-semibold py-3.5 px-8 rounded-xl sm:rounded-full shadow-lg shadow-emerald-600/20 active:transform active:scale-95 transition-all flex items-center justify-center gap-2.5"
                        >
                            {isSaving ? <IconLoader2_24 size={18} className="animate-spin" /> : <IconSave size={18} />}
                            {isSaving ? 'Guardando...' : 'Guardar Sesión'}
                        </button>
                    </div>
                    )}
                </div>

                {/* Floating Action Button (Mobile Only) */}
                <button
                    onClick={() => setIsModalOpen(true)}
                    className="sm:hidden fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 text-white rounded-2xl shadow-xl shadow-indigo-600/30 flex items-center justify-center active:scale-90 transition-transform z-30"
                >
                    <IconPlus size={28} />
                </button>

                {/* Add Program Modal Overlay */}
                {isModalOpen && (
                    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-slate-900/40 backdrop-blur-sm p-0 sm:p-4 animate-fadeIn">
                    {/* Modal Container */}
                    <div className="bg-white w-full max-w-lg rounded-t-3xl sm:rounded-2xl max-h-[85vh] flex flex-col shadow-2xl overflow-hidden animate-slideUp">
                        
                        {/* Header */}
                        <div className="p-4 border-b border-slate-100 flex items-center justify-between bg-white shrink-0">
                        <h3 className="font-bold text-slate-800 text-lg">Seleccionar Programa</h3>
                        <button 
                            onClick={() => setIsModalOpen(false)}
                            className="p-2 text-slate-400 hover:bg-slate-100 rounded-full transition-colors"
                        >
                            <IconX_20 size={20} />
                        </button>
                        </div>

                        {/* Search Input */}
                        <div className="p-4 bg-slate-50 border-b border-slate-100 shrink-0">
                        <div className="relative">
                            <IconSearch className="absolute left-3.5 top-1/2 transform -translate-y-1/2 text-slate-400" size={18} />
                            <input
                            autoFocus
                            type="text"
                            placeholder="Buscar..."
                            className="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all shadow-sm"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                        </div>

                        {/* List */}
                        <div className="overflow-y-auto p-2">
                        {isLoading ? (
                            <div className="py-12 flex flex-col items-center text-slate-400 gap-2">
                                <IconLoader2_24 className="animate-spin" size={24}/>
                                <span className="text-sm">Cargando catálogo...</span>
                            </div>
                        ) : (
                            <div className="space-y-1">
                            {/* Create New Option */}
                            {searchTerm && !exactMatchExists && (
                                <button
                                onClick={() => handleAdd(searchTerm)}
                                className="w-full text-left p-3.5 rounded-xl flex items-center gap-3 text-indigo-600 bg-indigo-50 hover:bg-indigo-100 border border-indigo-100 transition-colors mb-2"
                                >
                                <div className="w-8 h-8 rounded-full bg-indigo-200 flex items-center justify-center shrink-0">
                                    <IconPlus size={16} className="text-indigo-700" />
                                </div>
                                <div className="flex-1">
                                    <span className="font-semibold block">Crear "{searchTerm}"</span>
                                    <span className="text-xs opacity-80">Agregar como nuevo programa</span>
                                </div>
                                </button>
                            )}

                            {/* Existing Options */}
                            {filteredOptions.length > 0 ? (
                                filteredOptions.map((prog) => (
                                <button
                                    key={prog}
                                    onClick={() => handleAdd(prog)}
                                    className="w-full text-left p-3.5 rounded-xl flex items-center justify-between text-slate-700 hover:bg-slate-50 hover:text-slate-900 border border-transparent hover:border-slate-100 transition-all group"
                                >
                                    <span className="font-medium text-sm sm:text-base">{prog}</span>
                                    <div className="w-6 h-6 rounded-full border border-slate-200 flex items-center justify-center group-hover:border-indigo-300 group-hover:bg-indigo-50">
                                        <IconPlus size={12} className="text-slate-300 group-hover:text-indigo-500"/>
                                    </div>
                                </button>
                                ))
                            ) : (
                                !searchTerm && (
                                <div className="py-8 text-center text-slate-400 text-sm">
                                    Escribe para buscar o crear un programa
                                </div>
                                )
                            )}
                            
                            {/* No results message */}
                            {searchTerm && filteredOptions.length === 0 && !isLoading && (
                                <div className="px-4 py-2 text-xs text-slate-400 uppercase font-semibold tracking-wider">
                                Resultados de búsqueda
                                </div>
                            )}
                            </div>
                        )}
                        </div>
                    </div>
                    </div>
                )}

                </main>
            );
        };
        
        // =================================================================
        // 6. LÓGICA PRINCIPAL (APP.tsx y index.tsx)
        // =================================================================

        // Helper para obtener fecha local YYYY-MM-DD
        const getLocalDate = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const App = () => {
            const [sessionData, setSessionData] = useState({
                studentName: '',
                therapistName: '',
                date: getLocalDate(),
                startTime: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }),
                endTime: '',
                generalObservations: '',
                programs: []
            });

            const [config, setConfig] = useState({ programs: [], students: [], therapists: [] });
            const [isConfigLoading, setIsConfigLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [saveStatus, setSaveStatus] = useState(null);
            const [errorMessage, setErrorMessage] = useState('');

            useEffect(() => {
                const loadConfig = async () => {
                setIsConfigLoading(true);
                try {
                    const data = await fetchSheetConfig();
                    setConfig(data);
                } catch (error) {
                    console.error("Error cargando configuración", error);
                    setErrorMessage("No se pudo conectar con Google Sheets. Revisa la publicación del Apps Script.");
                } finally {
                    setIsConfigLoading(false);
                }
                };
                loadConfig();
            }, []);

            const handleUpdateSession = (field, value) => {
                setSessionData(prev => ({ ...prev, [field]: value }));
            };

            const handleAddProgram = (name) => {
                const newProgram = {
                // Usamos Date.now() como ID temporal. Tu código original usaba crypto.randomUUID()
                id: Date.now().toString(), 
                name,
                level: '',
                elements: '',
                correctCount: 0,
                incorrectCount: 0,
                selectedHelp: [],
                selectedReinforcer: [],
                reinforcementSchedule: '',
                reinforcementScheduleTime: '',
                isCollapsed: false,
                notes: ''
                };
                setSessionData(prev => ({
                ...prev,
                programs: [...prev.programs, newProgram] 
                }));
            };

            const handleUpdateProgram = (id, updates) => {
                setSessionData(prev => ({
                ...prev,
                programs: prev.programs.map(p => p.id === id ? { ...p, ...updates } : p)
                }));
            };

            const handleRemoveProgram = (id) => {
                if (window.confirm('¿Estás seguro de eliminar este programa? Se perderán los datos contados.')) {
                setSessionData(prev => ({
                    ...prev,
                    programs: prev.programs.filter(p => p.id !== id)
                }));
                }
            };

            const handleSaveSession = async () => {
                // 1. Validaciones
                if (!sessionData.studentName || !sessionData.therapistName) {
                alert("Por favor selecciona un estudiante y un terapeuta.");
                return;
                }

                if (sessionData.programs.length === 0) {
                alert("Debes agregar al menos un programa para guardar.");
                return;
                }

                // 2. Preparar el guardado
                setIsSaving(true);
                setSaveStatus(null);
                setErrorMessage('');

                const endTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                const finalData = { ...sessionData, endTime };
                
                // 3. Llamar al servicio real
                try {
                    const result = await saveSessionToSheet(finalData);
                
                    if (result.success) {
                        setSaveStatus('success');
                        // Resetear formulario para la siguiente sesión
                        setSessionData(prev => ({
                            ...prev,
                            startTime: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }),
                            endTime: '',
                            generalObservations: '',
                            programs: [] 
                        }));
                        setTimeout(() => setSaveStatus(null), 4000);
                    } else {
                        setSaveStatus('error');
                        setErrorMessage(result.message || 'Error desconocido al guardar en Google Sheets.');
                    }
                } catch (e) {
                    setSaveStatus('error');
                    setErrorMessage('Error de conexión o red. Revisa la URL y la publicación del Apps Script.');
                } finally {
                    setIsSaving(false);
                }
            };

            // Renderizar un spinner mientras carga la configuración
            if (isConfigLoading) {
                 return (
                    <div className="w-full h-screen flex flex-col items-center justify-center text-slate-500">
                        <svg className="animate-spin" style={{width: '40px', height: '40px', marginBottom: '16px', color: '#6366f1'}} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p>Cargando configuración de Google Sheets...</p>
                        {errorMessage && <p className="text-rose-500 mt-4 text-sm max-w-sm text-center">{errorMessage}</p>}
                    </div>
                );
            }


            return (
                <div className="flex flex-col lg:flex-row min-h-screen bg-[#F8F7FF] text-slate-900 font-sans overflow-hidden selection:bg-indigo-100">
                <Sidebar 
                    data={sessionData} 
                    onUpdate={handleUpdateSession} 
                    studentOptions={config.students}
                    therapistOptions={config.therapists}
                    isLoading={false} // Ya cargamos, no debe estar en true
                    isOfflineMode={false}
                />

                <ProgramList 
                    programs={sessionData.programs}
                    availablePrograms={config.programs}
                    onAddProgram={handleAddProgram}
                    onUpdateProgram={handleUpdateProgram}
                    onRemoveProgram={handleRemoveProgram}
                    onSaveSession={handleSaveSession}
                    isSaving={isSaving}
                    isLoading={false} // Ya cargamos, no debe estar en true
                />

                {saveStatus === 'success' && (
                    <div className="fixed bottom-6 right-6 bg-emerald-600 text-white px-6 py-4 rounded-2xl shadow-xl flex items-center gap-3 animate-bounce z-50">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        <div>
                            <h4 className="font-bold">¡Sesión Guardada!</h4>
                            <p className="text-sm opacity-90">Listo para el siguiente registro.</p>
                        </div>
                    </div>
                )}

                {saveStatus === 'error' && (
                    <div className="fixed bottom-6 right-6 bg-rose-600 text-white px-6 py-4 rounded-2xl shadow-xl flex items-start gap-3 animate-fadeIn z-50 max-w-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                        <div>
                            <h4 className="font-bold">Error al Guardar</h4>
                            <p className="text-sm opacity-90 leading-tight mt-1">{errorMessage}</p>
                        </div>
                        <button onClick={() => setSaveStatus(null)} className="ml-2 text-white/50 hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                )}
                </div>
            );
        };

        // Renderizado Final
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
