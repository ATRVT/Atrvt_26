<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registros ATREVETE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #F8F7FF; font-family: sans-serif; }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Estilos personalizados para Tailwind */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 1. CONFIGURACIÓN DEL SERVICIO (TU URL) ---
        // ESTA ES LA URL DE TU SCRIPT DE GOOGLE
        const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwxuRanzdOQ2NVkbfMHz0q2En00gG-_oYnHWeak3omCgFuuSntJXN6191zNjKkShdLBWQ/exec';

        const fetchSheetConfig = async () => {
            // Se envía 'requestType=GET_CONFIG' para que tu Apps Script sepa que debe enviar la configuración
            const url = `${APP_SCRIPT_URL}?requestType=GET_CONFIG`;
            const response = await fetch(url);
            
            if (!response.ok) {
                // Esto podría significar un error de red o que el Apps Script no funciona correctamente.
                console.error("Error al conectar con Apps Script. ¿El script está publicado como Web App?");
                throw new Error('Error de red o el servicio de Apps Script no está disponible.');
            }
            
            // Asumimos que Apps Script devuelve un JSON con { students: [], therapists: [], programs: [] }
            return response.json();
        };

        const saveSessionToSheet = async (data) => {
            // Se envía un POST con 'requestType=SAVE_SESSION' y el formulario como payload
            const response = await fetch(APP_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    requestType: 'SAVE_SESSION', 
                    payload: data 
                })
            });
            
            if (!response.ok) {
                throw new Error('Error al enviar datos. Asegúrate de que el Apps Script acepta POST.');
            }
            
            // Asumimos que Apps Script devuelve un JSON con { success: true/false, message: '...' }
            return response.json(); 
        };

        // --- 2. COMPONENTES RECREADOS (Sidebar y ProgramList) ---
        
        // Componente: Iconos
        const IconCheck = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const IconAlert = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
        const IconX = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const IconTrash = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;

        const Sidebar = ({ data, onUpdate, studentOptions, therapistOptions, isLoading }) => (
            <div className="w-full lg:w-80 bg-white p-6 border-r border-slate-200 flex flex-col gap-6 shadow-sm">
                <h2 className="text-xl font-bold text-indigo-700">Configuración Sesión</h2>
                
                {isLoading ? (
                    <div className="text-center py-4 text-slate-500">Cargando opciones...</div>
                ) : (
                    <>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Estudiante</label>
                            <select 
                                className="w-full p-2 border rounded-lg bg-slate-50"
                                value={data.studentName}
                                onChange={(e) => onUpdate('studentName', e.target.value)}
                            >
                                <option value="">Seleccionar...</option>
                                {studentOptions.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Terapeuta</label>
                            <select 
                                className="w-full p-2 border rounded-lg bg-slate-50"
                                value={data.therapistName}
                                onChange={(e) => onUpdate('therapistName', e.target.value)}
                            >
                                <option value="">Seleccionar...</option>
                                {therapistOptions.map(t => <option key={t} value={t}>{t}</option>)}
                            </select>
                        </div>
                    </>
                )}

                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block text-xs font-bold text-slate-500 uppercase">Fecha</label>
                        <input type="date" className="w-full p-2 border rounded bg-slate-50 text-sm" value={data.date} onChange={(e) => onUpdate('date', e.target.value)} />
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-slate-500 uppercase">Hora Inicio</label>
                        <input type="time" className="w-full p-2 border rounded bg-slate-50 text-sm" value={data.startTime} onChange={(e) => onUpdate('startTime', e.target.value)} />
                    </div>
                </div>

                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">Observaciones Generales</label>
                    <textarea 
                        className="w-full p-2 border rounded-lg bg-slate-50 h-24 text-sm"
                        placeholder="Notas generales de la sesión..."
                        value={data.generalObservations}
                        onChange={(e) => onUpdate('generalObservations', e.target.value)}
                    />
                </div>
            </div>
        );

        const ProgramList = ({ programs, availablePrograms, onAddProgram, onUpdateProgram, onRemoveProgram, onSaveSession, isSaving, isLoading }) => {
            const [selectedProg, setSelectedProg] = useState("");

            const handleAdd = () => {
                if(selectedProg) {
                    onAddProgram(selectedProg);
                    setSelectedProg("");
                }
            };

            return (
                <div className="flex-1 p-6 overflow-y-auto">
                    <header className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold text-slate-800">Programas Activos</h1>
                        <button 
                            onClick={onSaveSession}
                            disabled={isSaving || programs.length === 0}
                            className={`px-6 py-2 rounded-lg font-bold text-white transition-all ${isSaving || programs.length === 0 ? 'bg-slate-300 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 shadow-lg hover:shadow-indigo-200'}`}
                        >
                            {isSaving ? 'Guardando...' : 'Finalizar y Guardar'}
                        </button>
                    </header>

                    {/* Selector de programas */}
                    <div className="bg-white p-4 rounded-xl shadow-sm mb-6 flex gap-3 items-end border border-slate-100">
                        <div className="flex-1">
                            <label className="block text-sm font-medium text-slate-600 mb-1">Agregar Programa</label>
                            <select 
                                className="w-full p-2 border border-slate-300 rounded-lg"
                                value={selectedProg}
                                onChange={(e) => setSelectedProg(e.target.value)}
                                disabled={isLoading}
                            >
                                <option value="">-- Seleccionar programa del catálogo --</option>
                                {availablePrograms.map(p => <option key={p} value={p}>{p}</option>)}
                            </select>
                        </div>
                        <button 
                            onClick={handleAdd}
                            disabled={!selectedProg || isLoading}
                            className="bg-slate-800 text-white px-4 py-2 rounded-lg hover:bg-slate-900 disabled:opacity-50"
                        >
                            + Agregar
                        </button>
                    </div>

                    {/* Lista de programas */}
                    <div className="space-y-4">
                        {programs.length === 0 && (
                            <div className="text-center py-12 text-slate-400 bg-white rounded-xl border border-dashed border-slate-300">
                                <p>No hay programas activos en esta sesión.</p>
                                <p className="text-sm">Selecciona uno arriba para comenzar.</p>
                            </div>
                        )}
                        
                        {programs.map(prog => (
                            <div key={prog.id} className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 animate-fadeIn">
                                <div className="flex justify-between items-start mb-4 border-b border-slate-100 pb-2">
                                    <h3 className="font-bold text-lg text-slate-800">{prog.name}</h3>
                                    <button onClick={() => onRemoveProgram(prog.id)} className="text-rose-500 hover:bg-rose-50 p-1 rounded">
                                        <IconTrash />
                                    </button>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Notas / Nivel</label>
                                        <input 
                                            type="text" 
                                            className="w-full border rounded p-1 text-sm mt-1"
                                            value={prog.notes}
                                            onChange={(e) => onUpdateProgram(prog.id, { notes: e.target.value })}
                                            placeholder="Ej. Nivel 2, Pasos..."
                                        />
                                    </div>
                                    <div className="flex gap-4 items-center bg-slate-50 p-2 rounded-lg">
                                        <div className="text-center flex-1">
                                            <div className="text-xs font-bold text-emerald-600 uppercase">Correcto</div>
                                            <div className="flex items-center justify-center gap-2 mt-1">
                                                <button className="w-8 h-8 rounded-full bg-emerald-100 text-emerald-700 font-bold hover:bg-emerald-200" onClick={() => onUpdateProgram(prog.id, { correctCount: Math.max(0, prog.correctCount - 1) })}>-</button>
                                                <span className="text-xl font-mono w-8">{prog.correctCount}</span>
                                                <button className="w-8 h-8 rounded-full bg-emerald-600 text-white font-bold hover:bg-emerald-700" onClick={() => onUpdateProgram(prog.id, { correctCount: prog.correctCount + 1 })}>+</button>
                                            </div>
                                        </div>
                                        <div className="w-px h-10 bg-slate-300"></div>
                                        <div className="text-center flex-1">
                                            <div className="text-xs font-bold text-rose-600 uppercase">Incorrecto</div>
                                            <div className="flex items-center justify-center gap-2 mt-1">
                                                <button className="w-8 h-8 rounded-full bg-rose-100 text-rose-700 font-bold hover:bg-rose-200" onClick={() => onUpdateProgram(prog.id, { incorrectCount: Math.max(0, prog.incorrectCount - 1) })}>-</button>
                                                <span className="text-xl font-mono w-8">{prog.incorrectCount}</span>
                                                <button className="w-8 h-8 rounded-full bg-rose-600 text-white font-bold hover:bg-rose-700" onClick={() => onUpdateProgram(prog.id, { incorrectCount: prog.incorrectCount + 1 })}>+</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };


        // --- 3. TU LÓGICA PRINCIPAL (APP) ---
        // Helper para obtener fecha local YYYY-MM-DD
        const getLocalDate = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const App = () => {
            const [sessionData, setSessionData] = useState({
                studentName: '',
                therapistName: '',
                date: getLocalDate(),
                startTime: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }),
                endTime: '',
                generalObservations: '',
                programs: []
            });

            const [config, setConfig] = useState({ programs: [], students: [], therapists: [] });
            const [isConfigLoading, setIsConfigLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [saveStatus, setSaveStatus] = useState(null);
            const [errorMessage, setErrorMessage] = useState('');

            useEffect(() => {
                const loadConfig = async () => {
                setIsConfigLoading(true);
                try {
                    const data = await fetchSheetConfig();
                    // data: { students: [...], therapists: [...], programs: [...] }
                    setConfig(data);
                } catch (error) {
                    console.error("Error cargando configuración", error);
                    setErrorMessage("No se pudo conectar con Google Sheets. Revisa la publicación del Apps Script.");
                } finally {
                    setIsConfigLoading(false);
                }
                };
                loadConfig();
            }, []);

            const handleUpdateSession = (field, value) => {
                setSessionData(prev => ({ ...prev, [field]: value }));
            };

            const handleAddProgram = (name) => {
                const newProgram = {
                id: crypto.randomUUID(),
                name,
                level: '',
                elements: '',
                correctCount: 0,
                incorrectCount: 0,
                selectedHelp: [],
                selectedReinforcer: [],
                reinforcementSchedule: '',
                reinforcementScheduleTime: '',
                isCollapsed: false,
                notes: ''
                };
                setSessionData(prev => ({
                ...prev,
                programs: [...prev.programs, newProgram] 
                }));
            };

            const handleUpdateProgram = (id, updates) => {
                setSessionData(prev => ({
                ...prev,
                programs: prev.programs.map(p => p.id === id ? { ...p, ...updates } : p)
                }));
            };

            const handleRemoveProgram = (id) => {
                if (window.confirm('¿Estás seguro de eliminar este programa? Se perderán los datos contados.')) {
                setSessionData(prev => ({
                    ...prev,
                    programs: prev.programs.filter(p => p.id !== id)
                }));
                }
            };

            const handleSaveSession = async () => {
                // 1. Validaciones
                if (!sessionData.studentName || !sessionData.therapistName) {
                alert("Por favor selecciona un estudiante y un terapeuta.");
                return;
                }

                if (sessionData.programs.length === 0) {
                alert("Debes agregar al menos un programa para guardar.");
                return;
                }

                // 2. Preparar el guardado
                setIsSaving(true);
                setSaveStatus(null);
                setErrorMessage('');

                const endTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                const finalData = { ...sessionData, endTime };
                
                // 3. Llamar al servicio real
                try {
                const result = await saveSessionToSheet(finalData);
                
                if (result.success) {
                    setSaveStatus('success');
                    // Resetear formulario para la siguiente sesión
                    setSessionData(prev => ({
                    ...prev,
                    startTime: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }),
                    endTime: '',
                    generalObservations: '',
                    programs: [] 
                    }));
                    setTimeout(() => setSaveStatus(null), 4000);
                } else {
                    setSaveStatus('error');
                    setErrorMessage(result.message || 'Error desconocido al guardar en Google Sheets.');
                }
                } catch (e) {
                setSaveStatus('error');
                setErrorMessage('Error de conexión o red. Revisa la URL y la publicación del Apps Script.');
                } finally {
                setIsSaving(false);
                }
            };

            return (
                <div className="flex flex-col lg:flex-row min-h-screen bg-[#F8F7FF] text-slate-900 font-sans overflow-hidden selection:bg-indigo-100">
                {isConfigLoading ? (
                    <div className="w-full h-screen flex flex-col items-center justify-center text-slate-500">
                        <svg className="animate-spin" style={{width: '40px', height: '40px', marginBottom: '16px', color: '#6366f1'}} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p>Cargando configuración de Google Sheets...</p>
                        {errorMessage && <p className="text-rose-500 mt-4 text-sm max-w-sm text-center">{errorMessage}</p>}
                    </div>
                ) : (
                    <>
                        <Sidebar 
                            data={sessionData} 
                            onUpdate={handleUpdateSession} 
                            studentOptions={config.students}
                            therapistOptions={config.therapists}
                            isLoading={isConfigLoading}
                            isOfflineMode={false}
                        />

                        <ProgramList 
                            programs={sessionData.programs}
                            availablePrograms={config.programs}
                            onAddProgram={handleAddProgram}
                            onUpdateProgram={handleUpdateProgram}
                            onRemoveProgram={handleRemoveProgram}
                            onSaveSession={handleSaveSession}
                            isSaving={isSaving}
                            isLoading={isConfigLoading}
                        />

                        {saveStatus === 'success' && (
                            <div className="fixed bottom-6 right-6 bg-emerald-600 text-white px-6 py-4 rounded-2xl shadow-xl flex items-center gap-3 animate-bounce z-50">
                            <IconCheck />
                            <div>
                                <h4 className="font-bold">¡Sesión Guardada!</h4>
                                <p className="text-sm opacity-90">Listo para el siguiente registro.</p>
                            </div>
                            </div>
                        )}

                        {saveStatus === 'error' && (
                            <div className="fixed bottom-6 right-6 bg-rose-600 text-white px-6 py-4 rounded-2xl shadow-xl flex items-start gap-3 animate-fadeIn z-50 max-w-sm">
                            <IconAlert />
                            <div>
                                <h4 className="font-bold">Error al Guardar</h4>
                                <p className="text-sm opacity-90 leading-tight mt-1">{errorMessage}</p>
                            </div>
                            <button onClick={() => setSaveStatus(null)} className="ml-2 text-white/50 hover:text-white">
                                <IconX />
                            </button>
                            </div>
                        )}
                    </>
                )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
