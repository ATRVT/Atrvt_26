<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registros ATREVETE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #F8F7FF; font-family: sans-serif; }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 1. SIMULACIÓN DE SERVICIOS (Porque no tengo tus archivos de conexión) ---
        const fetchSheetConfig = async () => {
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve({
                        students: ['Juan Pérez', 'María Gómez', 'Carlos López'],
                        therapists: ['Lic. Ana', 'Lic. Pedro', 'Lic. Sofía'],
                        programs: ['Imitación Motora', 'Emparejamiento', 'Lenguaje Receptivo']
                    });
                }, 1000);
            });
        };

        const saveSessionToSheet = async (data) => {
            console.log("Guardando datos:", data);
            return new Promise(resolve => {
                setTimeout(() => resolve({ success: true }), 1500);
            });
        };

        // --- 2. COMPONENTES RECREADOS (Sidebar y ProgramList básicos) ---
        
        // Componente: Iconos
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const IconAlert = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
        const IconX = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;

        const Sidebar = ({ data, onUpdate, studentOptions, therapistOptions, isLoading }) => (
            <div className="w-full lg:w-80 bg-white p-6 border-r border-slate-200 flex flex-col gap-6 shadow-sm">
                <h2 className="text-xl font-bold text-indigo-700">Configuración Sesión</h2>
                
                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">Estudiante</label>
                    <select 
                        className="w-full p-2 border rounded-lg bg-slate-50"
                        value={data.studentName}
                        onChange={(e) => onUpdate('studentName', e.target.value)}
                        disabled={isLoading}
                    >
                        <option value="">Seleccionar...</option>
                        {studentOptions.map(s => <option key={s} value={s}>{s}</option>)}
                    </select>
                </div>

                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">Terapeuta</label>
                    <select 
                        className="w-full p-2 border rounded-lg bg-slate-50"
                        value={data.therapistName}
                        onChange={(e) => onUpdate('therapistName', e.target.value)}
                        disabled={isLoading}
                    >
                        <option value="">Seleccionar...</option>
                        {therapistOptions.map(t => <option key={t} value={t}>{t}</option>)}
                    </select>
                </div>

                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block text-xs font-bold text-slate-500 uppercase">Fecha</label>
                        <input type="date" className="w-full p-2 border rounded bg-slate-50 text-sm" value={data.date} onChange={(e) => onUpdate('date', e.target.value)} />
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-slate-500 uppercase">Hora Inicio</label>
                        <input type="time" className="w-full p-2 border rounded bg-slate-50 text-sm" value={data.startTime} onChange={(e) => onUpdate('startTime', e.target.value)} />
                    </div>
                </div>

                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">Observaciones Generales</label>
                    <textarea 
                        className="w-full p-2 border rounded-lg bg-slate-50 h-24 text-sm"
                        placeholder="Notas generales de la sesión..."
                        value={data.generalObservations}
                        onChange={(e) => onUpdate('generalObservations', e.target.value)}
                    />
                </div>
            </div>
        );

        const ProgramList = ({ programs, availablePrograms, onAddProgram, onUpdateProgram, onRemoveProgram, onSaveSession, isSaving, isLoading }) => {
            const [selectedProg, setSelectedProg] = useState("");

            const handleAdd = () => {
                if(selectedProg) {
                    onAddProgram(selectedProg);
                    setSelectedProg("");
                }
            };

            return (
                <div className="flex-1 p-6 overflow-y-auto">
                    <header className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold text-slate-800">Programas Activos</h1>
                        <button 
                            onClick={onSaveSession}
                            disabled={isSaving || programs.length === 0}
                            className={`px-6 py-2 rounded-lg font-bold text-white transition-all ${isSaving || programs.length === 0 ? 'bg-slate-300 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 shadow-lg hover:shadow-indigo-200'}`}
                        >
                            {isSaving ? 'Guardando...' : 'Finalizar y Guardar'}
                        </button>
                    </header>

                    {/* Selector de programas */}
                    <div className="bg-white p-4 rounded-xl shadow-sm mb-6 flex gap-3 items-end border border-slate-100">
                        <div className="flex-1">
                            <label className="block text-sm font-medium text-slate-600 mb-1">Agregar Programa</label>
                            <select 
                                className="w-full p-2 border border-slate-300 rounded-lg"
                                value={selectedProg}
                                onChange={(e) => setSelectedProg(e.target.value)}
                                disabled={isLoading}
                            >
                                <option value="">-- Seleccionar programa del catálogo --</option>
                                {availablePrograms.map(p => <option key={p} value={p}>{p}</option>)}
                            </select>
                        </div>
                        <button 
                            onClick={handleAdd}
                            disabled={!selectedProg}
                            className="bg-slate-800 text-white px-4 py-2 rounded-lg hover:bg-slate-900 disabled:opacity-50"
                        >
                            + Agregar
                        </button>
                    </div>

                    {/* Lista de programas */}
                    <div className="space-y-4">
                        {programs.length === 0 && (
                            <div className="text-center py-12 text-slate-400 bg-white rounded-xl border border-dashed border-slate-300">
                                <p>No hay programas activos en esta sesión.</p>
                                <p className="text-sm">Selecciona uno arriba para comenzar.</p>
                            </div>
                        )}
                        
                        {programs.map(prog => (
                            <div key={prog.id} className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 animate-fadeIn">
                                <div className="flex justify-between items-start mb-4 border-b border-slate-100 pb-2">
                                    <h3 className="font-bold text-lg text-slate-800">{prog.name}</h3>
                                    <button onClick={() => onRemoveProgram(prog.id)} className="text-rose-500 hover:bg-rose-50 p-1 rounded">
                                        <IconTrash />
                                    </button>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Notas / Nivel</label>
                                        <input 
                                            type="text" 
                                            className="w-full border rounded p-1 text-sm mt-1"
                                            value={prog.notes}
                                            onChange={(e) => onUpdateProgram(prog.id, { notes: e.target.value })}
                                            placeholder="Ej. Nivel 2, Pasos..."
                                        />
                                    </div>
                                    <div className="flex gap-4 items-center bg-slate-50 p-2 rounded-lg">
                                        <div className="text-center flex-1">
                                            <div className="text-xs font-bold text-emerald-600 uppercase">Correcto</div>
                                            <div className="flex items-center justify-center gap-2 mt-1">
                                                <button className="w-8 h-8 rounded-full bg-emerald-100 text-emerald-700 font-bold hover:bg-emerald-200" onClick={() => onUpdateProgram(prog.id, { correctCount: Math.max(0, prog.correctCount - 1) })}>-</button>
                                                <span className="text-xl font-mono w-8">{prog.correctCount}</span>
                                                <button className="w-8 h-8 rounded-full bg-emerald-600 text-white font-bold hover:bg-emerald-700" onClick={() => onUpdateProgram(prog.id, { correctCount: prog.correctCount + 1 })}>+</button>
                                            </div>
                                        </div>
                                        <div className="w-px h-10 bg-slate-300"></div>
                                        <div className="text-center flex-1">
                                            <div className="text-xs font-bold text-rose-600 uppercase">Incorrecto</div>
                                            <div className="flex items-center justify-center gap-2 mt-1">
                                                <button className="w-8 h-8 rounded-full bg-rose-100 text-rose-700 font-bold hover:bg-rose-200" onClick={() => onUpdateProgram(prog.id, { incorrectCount: Math.max(0, prog.incorrectCount - 1) })}>-</button>
                                                <span className="text-xl font-mono w-8">{prog.incorrectCount}</span>
                                                <button className="w-8 h-8 rounded-full bg-rose-600 text-white font-bold hover:bg-rose-700" onClick={() => onUpdateProgram(prog.id, { incorrectCount: prog.incorrectCount + 1 })}>+</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- 3. TU LÓGICA PRINCIPAL (APP) ---
        // Helper para obtener fecha local YYYY-MM-DD
        const getLocalDate = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const App = () => {
            const [sessionData, setSessionData] = useState({
                studentName: '',
                therapistName: '',
                date: getLocalDate(),
                startTime: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }),
                endTime: '',
                generalObservations: '',
                programs: []
            });

            const [config, setConfig] = useState({ programs: [], students: [], therapists: [] });
            const [isConfigLoading, setIsConfigLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [saveStatus, setSaveStatus] = useState(null);
            const [errorMessage, setErrorMessage] = useState('');

            useEffect(() => {
                const loadConfig = async () => {
                setIsConfigLoading(true);
                try {
                    const data = await fetchSheetConfig();
                    setConfig(data);
                } catch (error) {
                    console.error("Error cargando configuración", error);
                } finally {
                    setIsConfigLoading(false);
                }
                };
                loadConfig();
            }, []);

            const handleUpdateSession = (field, value) => {
                setSessionData(prev => ({ ...prev, [field]: value }));
            };

            const handleAddProgram = (name) => {
                const newProgram = {
                id: crypto.randomUUID(),
                name,
                level: '',
                elements: '',
                correctCount: 0,
                incorrectCount: 0,
                selectedHelp: [],
                selectedReinforcer: [],
                reinforcementSchedule: '',
                reinforcementScheduleTime: '',
                isCollapsed: false,
                notes: ''
                };
                setSessionData(prev => ({
                ...prev,
                programs: [...prev.programs, newProgram] 
                }));
            };

            const handleUpdateProgram = (id, updates) => {
                setSessionData(prev => ({
                ...prev,
                programs: prev.programs.map(p => p.id === id ? { ...p, ...updates } : p)
                }));
            };

            const handleRemoveProgram = (id) => {
                if (window.confirm('¿Estás seguro de eliminar este programa? Se perderán los datos contados.')) {
                setSessionData(prev => ({
                    ...prev,
                    programs: prev.programs.filter(p => p.id !== id)
                }));
                }
            };

            const handleSaveSession = async () => {
                if (!sessionData.studentName || !sessionData.therapistName) {
                alert("Por favor selecciona un estudiante y un terapeuta.");
                return;
                }

                if (sessionData.programs.length === 0) {
                alert("Debes agregar al menos un programa para guardar.");
                return;
                }

                setIsSaving(true);
                setSaveStatus(null);
                setErrorMessage('');

                const endTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                const finalData = { ...sessionData, endTime };
                
                try {
                const result = await saveSessionToSheet(finalData);
                
                if (result.success) {
                    setSaveStatus('success');
                    setSessionData(prev => ({
                    ...prev,
                    startTime: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }),
                    endTime: '',
                    generalObservations: '',
                    programs: [] 
                    }));
                    setTimeout(() => setSaveStatus(null), 4000);
                } else {
                    setSaveStatus('error');
                    setErrorMessage(result.message || 'Error desconocido');
                }
                } catch (e) {
                setSaveStatus('error');
                setErrorMessage('Error de conexión o red');
                } finally {
                setIsSaving(false);
                }
            };

            return (
                <div className="flex flex-col lg:flex-row min-h-screen bg-[#F8F7FF] text-slate-900 font-sans overflow-hidden selection:bg-indigo-100">
                <Sidebar 
                    data={sessionData} 
                    onUpdate={handleUpdateSession} 
                    studentOptions={config.students}
                    therapistOptions={config.therapists}
                    isLoading={isConfigLoading}
                    isOfflineMode={false}
                />

                <ProgramList 
                    programs={sessionData.programs}
                    availablePrograms={config.programs}
                    onAddProgram={handleAddProgram}
                    onUpdateProgram={handleUpdateProgram}
                    onRemoveProgram={handleRemoveProgram}
                    onSaveSession={handleSaveSession}
                    isSaving={isSaving}
                    isLoading={isConfigLoading}
                />

                {saveStatus === 'success' && (
                    <div className="fixed bottom-6 right-6 bg-emerald-600 text-white px-6 py-4 rounded-2xl shadow-xl flex items-center gap-3 animate-bounce z-50">
                    <IconCheck />
                    <div>
                        <h4 className="font-bold">¡Sesión Guardada!</h4>
                        <p className="text-sm opacity-90">Listo para el siguiente registro.</p>
                    </div>
                    </div>
                )}

                {saveStatus === 'error' && (
                    <div className="fixed bottom-6 right-6 bg-rose-600 text-white px-6 py-4 rounded-2xl shadow-xl flex items-start gap-3 animate-fadeIn z-50 max-w-sm">
                    <IconAlert />
                    <div>
                        <h4 className="font-bold">Error al Guardar</h4>
                        <p className="text-sm opacity-90 leading-tight mt-1">{errorMessage}</p>
                    </div>
                    <button onClick={() => setSaveStatus(null)} className="ml-2 text-white/50 hover:text-white">
                        <IconX />
                    </button>
                    </div>
                )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
